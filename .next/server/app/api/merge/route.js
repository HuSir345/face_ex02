"use strict";(()=>{var e={};e.id=86,e.ids=[86],e.modules={517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},3034:(e,o,t)=>{t.r(o),t.d(o,{headerHooks:()=>d,originalPathname:()=>w,requestAsyncStorage:()=>u,routeModule:()=>c,serverHooks:()=>p,staticGenerationAsyncStorage:()=>g,staticGenerationBailout:()=>m});var r={};t.r(r),t.d(r,{POST:()=>POST});var a=t(884),s=t(6132),n=t(5798);let i=require("sharp");var l=t.n(i);async function compressImage(e){try{let o=await e.arrayBuffer(),t=Buffer.from(o),r=.59+.4*Math.random(),a=Math.floor(80*r);console.log("压缩质量系数:",r.toFixed(6)),console.log("最终压缩质量:",a);let s=await l()(t).resize(1920,1920,{fit:"inside",withoutEnlargement:!0}).jpeg({quality:a,progressive:!0}).toBuffer(),n=new File([s],e.name,{type:"image/jpeg"});return console.log("压缩前大小:",(e.size/1024/1024).toFixed(2)+"MB"),console.log("压缩后大小:",(n.size/1024/1024).toFixed(2)+"MB"),n}catch(o){return console.error("图片压缩失败:",o),e}}async function uploadToImageHub(e,o=0){try{let o=new FormData;o.append("source",e);let t=await fetch(process.env.IMAGEHUB_API_URL,{method:"POST",headers:{"X-API-Key":process.env.IMAGEHUB_API_KEY},body:o});if(!t.ok)throw Error("图片上传失败");let r=await t.json();if(console.log("图床上传响应:",r),200!==r.status_code)throw Error(r.status_txt||"图片上传失败");return r.image.url}catch(t){if(o<2){console.log(`上传失败，尝试压缩后重新上传 (第${o+1}次)...`);let t=await compressImage(e instanceof File?e:new File([e],"image.jpg"));return uploadToImageHub(t,o+1)}throw t}}async function downloadAndUploadImage(e){try{console.log("开始下载图片:",e);let o=await fetch(e);if(!o.ok)throw Error("图片下载失败");let t=await o.blob();return console.log("图片下载完成，开始上传到图床"),await uploadToImageHub(t)}catch(e){throw console.error("下载并上传图片失败:",e),e}}async function POST(e){try{let o;let t=await e.formData(),r=t.get("image1"),a=t.get("image2");if(!r||!a)return n.Z.json({error:"请提供两张图片"},{status:400});console.log("开始上传原始图片到图床...");let[s,i]=await Promise.all([uploadToImageHub(r),uploadToImageHub(a)]);console.log("原始图片上传成功:"),console.log("图片1 URL:",s),console.log("图片2 URL:",i),console.log("准备调用 Coze API...");let l={workflow_id:process.env.WORKFLOW_ID.trim(),parameters:{face_image:s,base_image:i}},c=await fetch(process.env.COZE_API_URL,{method:"POST",headers:{Authorization:`Bearer ${process.env.AUTHORIZATION.trim()}`,"Content-Type":"application/json",Accept:"application/json","User-Agent":"Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36",Origin:"https://www.coze.cn",Referer:"https://www.coze.cn/"},body:JSON.stringify(l)});console.log("Coze API 响应状态:",c.status);let u=await c.json();if(console.log("Coze API 响应数据:",JSON.stringify(u,null,2)),!c.ok)throw Error(`Coze API 错误: ${c.status}`);if(0!==u.code)throw Error(u.msg||"处理失败");try{o="string"==typeof u.data?JSON.parse(u.data):u.data,console.log("解析后的输出数据:",o),console.log("开始上传生成的图片到图床...");let e=await downloadAndUploadImage(o.output);return console.log("生成的图片上传成功:",e),n.Z.json({resultUrl:e,originalUrl:o.output,rawResponse:u})}catch(e){throw console.log("原始返回数据:",u.data),Error("处理返回数据失败")}}catch(e){return console.error("错误详情:",{message:e.message,stack:e.stack,response:e.response}),n.Z.json({error:e.message||"处理失败",details:{message:e.message,response:e.response}},{status:500})}}let c=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/merge/route",pathname:"/api/merge",filename:"route",bundlePath:"app/api/merge/route"},resolvedPagePath:"D:\\Cursor\\face2exchange\\app\\api\\merge\\route.ts",nextConfigOutput:"",userland:r}),{requestAsyncStorage:u,staticGenerationAsyncStorage:g,serverHooks:p,headerHooks:d,staticGenerationBailout:m}=c,w="/api/merge/route"}};var o=require("../../../webpack-runtime.js");o.C(e);var __webpack_exec__=e=>o(o.s=e),t=o.X(0,[997],()=>__webpack_exec__(3034));module.exports=t})();